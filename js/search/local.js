class LocalSearch{constructor(){this.store=[],this.currentQuery="",this.currentPage=0,this.resultsPerPage=10,this.currentResults=[],this.isLoading=!1,this.searchTimeout=null,this.elements=this.cacheElements(),this.init()}cacheElements(){return{searchMask:document.getElementById("search-mask"),searchDialog:document.querySelector("#local-search .search-dialog"),searchInput:document.getElementById("search-input"),searchResults:document.getElementById("search-results"),searchPagination:document.getElementById("search-pagination"),searchTips:document.getElementById("search-tips"),searchButton:document.querySelector("#search-button > .search"),closeButton:document.querySelector("#local-search .search-close-button"),menuSearch:document.getElementById("menu-search")}}async init(){try{await this.loadSearchData(),this.bindEvents(),this.bindKeyboardShortcuts()}catch(e){console.error("Search initialization failed:",e)}}async loadSearchData(){if(!GLOBAL_CONFIG?.localsearch?.path)throw new Error("Search data path not configured");this.isLoading=!0;try{var e=await fetch(GLOBAL_CONFIG.localsearch.path);if(!e.ok)throw new Error(`HTTP ${e.status}: `+e.statusText);var t=await e.text();this.parseSearchData(t)}catch(e){throw new Error("Failed to load search data: "+e.message)}finally{this.isLoading=!1}}parseSearchData(e){try{var t=(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("entry");this.store=Array.from(t).map(t=>{var e=e=>{e=t.getElementsByTagName(e)[0];return e?e.textContent.trim():""};return{title:e("title"),link:e("url"),content:e("content")}}).filter(e=>e.title&&e.link)}catch(e){throw new Error("Failed to parse search data: "+e.message)}}bindEvents(){this.elements.searchInput?.addEventListener("input",this.debounce(e=>{this.handleSearchInput(e.target.value.trim())},300)),this.elements.searchButton?.addEventListener("click",()=>this.openSearch()),this.elements.closeButton?.addEventListener("click",()=>this.closeSearch()),this.elements.searchMask?.addEventListener("click",()=>this.closeSearch()),this.bindTagListEvents(),GLOBAL_CONFIG.right_menu&&this.elements.menuSearch&&this.elements.menuSearch.addEventListener("click",()=>{rm.hideRightMenu(),this.openSearch(),window.selectTextNow&&(this.elements.searchInput.value=window.selectTextNow,this.handleSearchInput(window.selectTextNow))}),window.addEventListener("pjax:complete",()=>{this.elements=this.cacheElements(),this.bindEvents()})}bindTagListEvents(){document.querySelectorAll("#local-search .tag-list").forEach(e=>{e.addEventListener("click",()=>this.closeSearch())})}bindKeyboardShortcuts(){document.addEventListener("keydown",e=>{e.ctrlKey&&"k"===e.key?(e.preventDefault(),this.openSearch()):"Escape"===e.code&&this.isSearchOpen()&&this.closeSearch()})}openSearch(){this.elements.searchMask&&this.elements.searchDialog&&(utils.animateIn(this.elements.searchMask,"to_show 0.5s"),this.elements.searchDialog.style.display="flex",setTimeout(()=>{this.elements.searchInput?.focus()},100),this.fixSafariHeight(),window.addEventListener("resize",this.fixSafariHeight),window.openSearch=()=>this.openSearch())}closeSearch(){this.elements.searchMask&&this.elements.searchDialog&&(utils.animateOut(this.elements.searchDialog,"search_close .5s"),utils.animateOut(this.elements.searchMask,"to_hide 0.5s"),window.removeEventListener("resize",this.fixSafariHeight),this.currentQuery="",this.currentPage=0)}isSearchOpen(){return"flex"===this.elements.searchDialog?.style.display}fixSafariHeight=()=>{window.innerWidth<768&&this.elements.searchDialog&&this.elements.searchDialog.style.setProperty("--search-height",window.innerHeight+"px")};handleSearchInput(e){if(!this.isLoading)if(this.currentQuery=e,this.currentPage=0,""===e)this.clearSearchResults();else try{var t=performance.now(),s=(this.currentResults=this.performSearch(e),performance.now()),r=(s-t).toFixed(2);this.renderResults(this.currentResults,this.currentPage,r),this.renderPagination(this.currentResults.length)}catch(e){console.error("Search error:",e),this.showErrorMessage("Search failed, please try again")}}performSearch(e){if(!e||!this.store.length)return[];let r=e.toLowerCase().split(/\s+/).filter(e=>0<e.length);return 0===r.length?[]:this.store.filter(e=>{let t=e.title.toLowerCase(),s=e.content.toLowerCase();return r.every(e=>t.includes(e)||s.includes(e))}).sort((e,t)=>{e=this.calculateRelevanceScore(e,r);return this.calculateRelevanceScore(t,r)-e})}calculateRelevanceScore(t,e){let s=0,r=t.title.toLowerCase();return e.forEach(e=>{r===e?s+=10:r.includes(e)?s+=5:t.content.toLowerCase().includes(e)&&(s+=1)}),s}renderResults(e,s,r=null){if(this.elements.searchResults&&this.elements.searchTips){this.elements.searchResults.innerHTML="",this.elements.searchTips.innerHTML="";var s=s*this.resultsPerPage,a=s+this.resultsPerPage;if(e.length){let t=document.createDocumentFragment();e.slice(s,a).forEach(e=>{e=this.createResultElement(e);t.appendChild(e)}),this.elements.searchResults.appendChild(t),this.showResultCount(e.length,r)}else this.showEmptyMessage()}}createResultElement(e){var t=document.createElement("li"),s=(t.className="search-result-item",document.createElement("a"));return s.className="search-result-title",s.href=e.link,s.innerHTML=this.highlightKeywords(e.title,this.currentQuery),t.appendChild(s),t}highlightKeywords(e,t){if(!t)return e;t=t.split(/\s+/).filter(e=>0<e.length);let s=e;return t.forEach(e=>{e=new RegExp(`(${this.escapeRegExp(e)})`,"gi");s=s.replace(e,"<em>$1</em>")}),s}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}renderPagination(e){if(this.elements.searchPagination){var t=Math.ceil(e/this.resultsPerPage);if(this.elements.searchPagination.innerHTML="",!(t<=1)){var s=document.createElement("ul");s.className="pagination-list";for(let e=0;e<t;e++){var r=this.createPaginationButton(e+1,e===this.currentPage);r.addEventListener("click",()=>this.goToPage(e)),s.appendChild(r)}this.elements.searchPagination.appendChild(s)}}}createPaginationButton(e,t){var s=document.createElement("li");return s.className="pagination-item",s.textContent=e,t&&s.classList.add("select"),s}goToPage(s){this.currentPage=s,this.renderResults(this.currentResults,s),document.querySelectorAll(".pagination-item").forEach((e,t)=>{e.classList.toggle("select",t===s)})}showEmptyMessage(){var e=document.createElement("span");e.className="search-result-empty",e.textContent=GLOBAL_CONFIG.lang?.search?.empty?.replace(/\$\{query}/,this.currentQuery)||`没有找到与 "${this.currentQuery}" 相关的内容`,this.elements.searchResults.appendChild(e)}showResultCount(e,t){var s=document.createElement("span");s.className="search-result-count",s.innerHTML=GLOBAL_CONFIG.lang?.search?.hit?.replace(/\$\{hits}/,e).replace(/\$\{time}/,t),this.elements.searchTips.appendChild(s)}showErrorMessage(e){var t;this.elements.searchResults&&(this.elements.searchResults.innerHTML="",(t=document.createElement("span")).className="search-result-error",t.textContent=e,this.elements.searchResults.appendChild(t))}clearSearchResults(){this.elements.searchResults&&(this.elements.searchResults.innerHTML=""),this.elements.searchPagination&&(this.elements.searchPagination.innerHTML=""),this.elements.searchTips&&(this.elements.searchTips.innerHTML=""),this.currentResults=[],this.currentPage=0}debounce(t,s){return(...e)=>{clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>t.apply(this,e),s)}}}window.addEventListener("load",()=>{window.localSearch=new LocalSearch});